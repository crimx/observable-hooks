<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Gotchas | Observable Hooks</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="description" content="React hooks for RxJS Observables. Simple, flexible, testable and performant.">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
    <meta name="theme-color" content="#9B59B6">
    <link rel="preload" href="/assets/css/0.styles.5e1f57d9.css" as="style"><link rel="preload" href="/assets/js/app.8a33961d.js" as="script"><link rel="preload" href="/assets/js/3.4924f867.js" as="script"><link rel="preload" href="/assets/js/15.81905663.js" as="script"><link rel="preload" href="/assets/js/4.f2192f58.js" as="script"><link rel="prefetch" href="/assets/js/10.9a2a9ecc.js"><link rel="prefetch" href="/assets/js/11.57fea06d.js"><link rel="prefetch" href="/assets/js/12.ac785721.js"><link rel="prefetch" href="/assets/js/13.cc7cfd07.js"><link rel="prefetch" href="/assets/js/14.f3d8d661.js"><link rel="prefetch" href="/assets/js/16.de6c994b.js"><link rel="prefetch" href="/assets/js/17.6caf1345.js"><link rel="prefetch" href="/assets/js/18.7dcf8f69.js"><link rel="prefetch" href="/assets/js/19.7a22ef11.js"><link rel="prefetch" href="/assets/js/20.56c9ed39.js"><link rel="prefetch" href="/assets/js/21.06bb16a7.js"><link rel="prefetch" href="/assets/js/22.b0ab3dd5.js"><link rel="prefetch" href="/assets/js/23.c11efe09.js"><link rel="prefetch" href="/assets/js/24.8db88c91.js"><link rel="prefetch" href="/assets/js/25.554c3a72.js"><link rel="prefetch" href="/assets/js/26.ad49b897.js"><link rel="prefetch" href="/assets/js/27.5ce383fa.js"><link rel="prefetch" href="/assets/js/28.ac61505f.js"><link rel="prefetch" href="/assets/js/29.d24e88d9.js"><link rel="prefetch" href="/assets/js/30.8b1b6c9f.js"><link rel="prefetch" href="/assets/js/31.3f251ee2.js"><link rel="prefetch" href="/assets/js/32.03261fb6.js"><link rel="prefetch" href="/assets/js/33.cc5d241c.js"><link rel="prefetch" href="/assets/js/34.9f40a0d4.js"><link rel="prefetch" href="/assets/js/35.e29a88fe.js"><link rel="prefetch" href="/assets/js/36.256f6589.js"><link rel="prefetch" href="/assets/js/37.f23acb65.js"><link rel="prefetch" href="/assets/js/38.b00f183c.js"><link rel="prefetch" href="/assets/js/39.01feda9b.js"><link rel="prefetch" href="/assets/js/40.5dfebc81.js"><link rel="prefetch" href="/assets/js/41.6828984e.js"><link rel="prefetch" href="/assets/js/42.a1adf8a6.js"><link rel="prefetch" href="/assets/js/5.1d4d528e.js"><link rel="prefetch" href="/assets/js/6.46a713d7.js"><link rel="prefetch" href="/assets/js/7.6dd24a86.js"><link rel="prefetch" href="/assets/js/8.594cab63.js"><link rel="prefetch" href="/assets/js/9.cd2df33f.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.e9a84dcc.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5e1f57d9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Observable Hooks</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/guide/" class="nav-link router-link-active">
  Guide
</a></div><div class="nav-item"><a href="/api/" class="nav-link">
  API
</a></div><div class="nav-item"><a href="/examples/" class="nav-link">
  Examples
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/guide/gotchas.html" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh-cn/guide/gotchas.html" class="nav-link">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/crimx/observable-hooks" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guide/" class="nav-link router-link-active">
  Guide
</a></div><div class="nav-item"><a href="/api/" class="nav-link">
  API
</a></div><div class="nav-item"><a href="/examples/" class="nav-link">
  Examples
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/guide/gotchas.html" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh-cn/guide/gotchas.html" class="nav-link">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/crimx/observable-hooks" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Guide</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/" class="sidebar-link">Installation</a></li><li><a href="/guide/core-concepts.html" class="sidebar-link">Core Concepts</a></li><li><a href="/guide/motivation.html" class="sidebar-link">Motivation</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Advanced</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/context.html" class="sidebar-link">With React Context</a></li><li><a href="/guide/render-as-you-fetch-suspense.html" class="sidebar-link">Render-as-You-Fetch (using Suspense)</a></li><li><a href="/guide/react-independent-epics.html" class="sidebar-link">React Independent Epics</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Miscellaneous</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/gotchas.html" class="active sidebar-link">Gotchas</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/gotchas.html#epic-closure" class="sidebar-link">Epic Closure</a></li><li class="sidebar-sub-header"><a href="/guide/gotchas.html#subscription-timing" class="sidebar-link">Subscription Timing</a></li></ul></li><li><a href="/guide/migration.html" class="sidebar-link">Migration</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="gotchas"><a href="#gotchas" class="header-anchor">#</a> Gotchas</h1> <h2 id="epic-closure"><a href="#epic-closure" class="header-anchor">#</a> Epic Closure</h2> <p>React Function Components can be called many times until they are unmounted.</p> <p>In observable-hooks, many hooks like <a href="#useobservable"><code>useObservable</code></a>, <a href="#useobservablecallback"><code>useObservableCallback</code></a> or <a href="#useobservablestate"><code>useObservableState</code></a> accept an epic-like function which will be called only once(could be more in concurrent mode) and always returns the same observable, until the component unmounts.</p> <p>Since the function is called only once it is not safe to directly reference other variables in closure.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> useObservableCallback <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'observable-hooks'</span>

<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>onChange<span class="token punctuation">,</span> textChange$<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useObservableCallback</span><span class="token punctuation">(</span>
    <span class="token parameter">event$</span> <span class="token operator">=&gt;</span> event$<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
      <span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">text</span><span class="token operator">:</span> event<span class="token punctuation">.</span>currentTarget<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
          <span class="token literal-property property">flag</span><span class="token operator">:</span> props<span class="token punctuation">.</span>flag <span class="token comment">// always the initial value</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>You may think of <code>useRef</code> but it is not safe either. In concurrent mode it could lead to tearing.</p> <p>You should convert it into Observable and use <code>withLatestFrom</code>.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> pluckFirst<span class="token punctuation">,</span> useObservableCallback <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'observable-hooks'</span>

<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> flag$ <span class="token operator">=</span> <span class="token function">useObservable</span><span class="token punctuation">(</span>pluckFirst<span class="token punctuation">,</span> <span class="token punctuation">[</span>props<span class="token punctuation">.</span>flag<span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> <span class="token punctuation">[</span>onChange<span class="token punctuation">,</span> textChange$<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useObservableCallback</span><span class="token punctuation">(</span>
    <span class="token parameter">event$</span> <span class="token operator">=&gt;</span> event$<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
      <span class="token function">withLatestFrom</span><span class="token punctuation">(</span>flag$<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>event<span class="token punctuation">,</span> flag<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">text</span><span class="token operator">:</span> event<span class="token punctuation">.</span>currentTarget<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
          flag
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="subscription-timing"><a href="#subscription-timing" class="header-anchor">#</a> Subscription Timing</h2> <p>To make observable-hooks compatible with React concurrent mode, the Observable subscription, which is side-effect to react, is established after the render is committed to the screen. It is unpredictable when the component will finish rendering, so there is a time gap. The observable-hooks will keep you safe from tearing, but if the not-yet-subscribed observable is hot and emits values during the time gap, those values will be lost.</p> <p>This should be rare case though. There should always be better ways to structure the code for this type of scenario.</p> <ol><li>If the hot observable is from DOM events:
<ol><li>For events that are triggered by user interaction like <code>click</code> and <code>keypress</code> it is safe to assume the subscription is established.</li> <li>If you are not sure or are having issues, use <a href="/api/#uselayoutsubscription"><code>useLayoutSubscription</code></a> which establishes subscription synchronously after the render phase and before browser paints.</li></ol></li> <li>If the observable is from other JavaScript module which you have no control of, it will be same issue even if subscription happens immediately on rendering. It is not safe to predict when the component will start rendering. In this case you should have a mechanism to cache the value, like <code>BehaviorSubject</code>.</li> <li>Also see <a href="/api/#useobservableeagerstate"><code>useObservableEagerState</code></a> which is optimized for observables with synchronous values.</li> <li>If you have control of the emission timing, delay it with <code>useEffect</code> plus one event loop. React may not follow the exact order when invoking <code>useEffect</code> callbacks. An extra event loop will make sure the emission happens after subscription.<div class="language-js extra-class"><pre class="language-js"><code><span class="token function">useEffect</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> didUnmount <span class="token operator">=</span> <span class="token boolean">false</span>

    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>didUnmount<span class="token punctuation">)</span> <span class="token keyword">return</span>

      hot$<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      didUnmount <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span>
</code></pre></div>You may create a custom hook if this pattern is frequently used.</li> <li>If you have better idea please share it with us or submit a PR!</li></ol></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/crimx/observable-hooks/edit/master/docs/guide/gotchas.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/guide/react-independent-epics.html" class="prev">
        React Independent Epics
      </a></span> <span class="next"><a href="/guide/migration.html">
        Migration
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.8a33961d.js" defer></script><script src="/assets/js/3.4924f867.js" defer></script><script src="/assets/js/15.81905663.js" defer></script><script src="/assets/js/4.f2192f58.js" defer></script>
  </body>
</html>
